var NeighborhoodViewModel=function(){var e=this;e.neighborhood={name:ko.observable("Udacity"),location:{lat:37.399864,lng:-122.10840000000002}},e.map=null,e.switchInputValue=ko.observable(""),e.searchInputValue=ko.observable(""),e.categories=ko.observableArray([]),e.initialize=function(){var o={disableDefaultUI:!0,center:e.neighborhood.location,zoom:18,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER,style:google.maps.ZoomControlStyle.DEFAULT}};e.map=new google.maps.Map(document.getElementById("map-canvas"),o),e.getCategories(function(o){o.forEach(function(e){e.isVisible=ko.observable(!0),e.isHidden=ko.computed(function(){return!e.isVisible()}),e.toggleVisibility=function(){this.isVisible(!e.isVisible()),this.places().forEach(function(e){e.infoWindowOpened()&&(e.infoWindow.close(),e.marker.setIcon(e.markerIcon),e.infoWindowOpened(!1)),e.matchesQuery()&&e.marker.setVisible(!e.marker.getVisible())})},e.places=ko.observableArray([]),e.placesMatchingQuery=ko.computed(function(){var o=[];return e.places().forEach(function(e){var n=e.matchesQuery();e.marker.setVisible(n),n?o.push(e):e.infoWindowOpened()&&(e.infoWindow.close(),e.marker.setIcon(e.markerIcon),e.infoWindowOpened(!1))}),o}),e.headerIcon=ko.computed(function(){var o=e.icon;return o.prefix+"44"+o.suffix}),e.displayName=ko.computed(function(){return e.pluralName.length>22?e.pluralName.substring(0,18)+" â€¦":e.pluralName})}),e.categories(o),e.findPlaces(e.neighborhood),e.activateNeighborhoodSwitch()})},e.activateNeighborhoodSwitch=function(){var o=document.getElementById("neighborhood"),n=new google.maps.places.SearchBox(o);google.maps.event.addListener(n,"places_changed",function(){var o=n.getPlaces();if(e.switchInputValue(""),0!==o.length){var r=o[0];if(r.hasOwnProperty("geometry")){var t=r.geometry;if(t.hasOwnProperty("location")){var i=t.location;e.neighborhood.name(r.name),e.neighborhood.location.lat=i.k,e.neighborhood.location.lng=i.D,e.switchNeighborhood(e.neighborhood)}}}})},e.switchNeighborhood=function(o){e.map.panTo(o.location),e.findPlaces(o)},e.findPlaces=function(o){var n=function(e){var o='<div class="place-info"><h4>'+e.name+"</h4>";if(e.categories.length>0){o+='<h5 class="categories-titles">'+e.categories[0].name;for(var n=1;n<e.categories.length;++n){var r=e.categories[n];o+=", "+r.pluralName}o+="</h5>"}return e.location.formattedAddress.length>0&&(o+="<br><address>",e.location.formattedAddress.forEach(function(e){o+=e+"<br>"}),o+="</address>"),e.hasOwnProperty("hours")&&e.hours.timeframes.forEach(function(e){o+='<div class="timeframe">';for(var n=e.daysOpen[0],r=1;r<e.daysOpen.length;++r)n+=" - "+e.daysOpen[r];o+="<p>"+n+"</p>",o+="<p>"+e.open.start+" - "+e.open.end+"</p>",o+="</div>"}),o+="</div>",new google.maps.InfoWindow({content:o})};apis.foursquare.getPlacesIn(o.location,function(o){e.categories().forEach(function(e){e.places([])}),o.forEach(function(o){o.matchesQuery=ko.computed(function(){for(var n=e.searchInputValue().toLowerCase(),r=0;r<o.categories.length;++r)if(-1!=o.categories[r].name.toLowerCase().search(n))return!0;return o.name.substring(0,n.length).toLowerCase()===n}),apis.foursquare.getPhotosOf(o,function(r){o.photos=r.items,o.thumbnail=ko.computed(function(){if(o.photos.length<=0)return"";var e=o.photos[0];return e.prefix+"100x100"+e.suffix});for(var t=0;t<o.photos.length;++t){var i=o.photos[t];i.position=t,i.placeId=o.id,i.preview=ko.computed(function(){return i.prefix+"500x500"+i.suffix})}o.formattedCategories=ko.computed(function(){if(o.categories.length<=0)return"";for(var e=o.categories[0].name,n=1;n<o.categories.length;++n)e+=", "+o.categories[n];return e}),apis.foursquare.getHoursOf(o,function(r){var t=function(e){return e.substring(0,2)+" h "+e.substring(2)};r.hasOwnProperty("timeframes")&&(r.timeframes.forEach(function(e){e.hasOwnProperty("days")&&(e.daysOpen=[],e.days.forEach(function(o){e.daysOpen.push(days[o])}),e.open.start=t(e.open[0].start),e.open.end=t(e.open[0].end))}),o.hours=r),o.infoWindow=n(o),o.infoWindowOpened=ko.observable(!1),o.toggleInfoWindow=function(){this.infoWindowOpened()?(o.marker.setIcon(o.markerIcon),this.infoWindow.close(),this.infoWindowOpened(!1)):(e.map.panTo(this.location),o.marker.setIcon(o.markerIcon.substring(0,o.markerIcon.length-4)+"_selected.png"),this.infoWindow.open(e.map,this.marker),this.infoWindowOpened(!0))},e.categories().forEach(function(n){e.isPlaceInCategory(n,o)&&(o.markerIcon=markers[n.id],o.marker=new google.maps.Marker({map:e.map,title:o.name,position:{lat:o.location.lat,lng:o.location.lng},icon:o.markerIcon}),n.places.push(o),o.categories.push(n))}),o.hasOwnProperty("marker")&&google.maps.event.addListener(o.marker,"click",function(){if(!o.infoWindowOpened()){o.infoWindow.open(e.map,o.marker);var n=o.marker.getIcon();o.marker.setIcon(n.substring(0,n.length-4)+"_selected.png"),o.infoWindowOpened(!0),document.getElementById(o.id).scrollIntoView()}}),google.maps.event.addListener(o.infoWindow,"closeclick",function(){o.marker.setIcon(o.markerIcon),o.infoWindowOpened(!1)})})})})})},e.isPlaceInCategory=function(o,n){for(var r=0;r<n.categories.length;++r)if(e.isSubCategoryOf(o,n.categories[r]))return!0;return!1},e.isSubCategoryOf=function(o,n){if(n.id===o.id)return!0;if(o.hasOwnProperty("categories"))for(var r=0;r<o.categories.length;++r)if(e.isSubCategoryOf(o.categories[r],n))return!0;return!1},e.getCategories=function(e){var o=Modernizr.localstorage&&null===localStorage.getItem("categories");o?apis.foursquare.getCategories(function(o){Modernizr.localstorage&&localStorage.setItem("categories",JSON.stringify(o)),e&&e(o)}):e&&e(JSON.parse(localStorage.getItem("categories")))},google.maps.event.addDomListener(window,"load",this.initialize)};$(document).ready(function(){ko.applyBindings(new NeighborhoodViewModel)});